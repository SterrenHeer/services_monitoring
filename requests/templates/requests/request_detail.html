{% extends 'base.html' %}

{% load custom_filters %}

{% block title %}
    Информация о заявке
{% endblock %}

{% block content %}
    <div class="col-10 mx-auto col-md-6 my-3 text-center">
        <h1>{{ request.service }}</h1>
        <h5 class="text-info font-italic mb-4">{{ request.service.service_type }}</h5>
        <p><strong>Дата подачи:</strong> {{ request.submission_date }}</p>
        <p><strong>Состояние:</strong> {{ request.status }}</p>
        <p><strong>Время начала:</strong> {{ request.start_time }}</p>
        <p><strong>Время завершения:</strong> {{ request.end_time }}</p>
        <p><strong>Предполагаемая стоимость:</strong> {{ request.service.price }} руб.</p>
        {% if user|has_group:"Manager" %}
        <p><strong>Закреплённый работник:</strong></p>
        <p><strong>Подал заявку:</strong> {{ request.tenant }}</p>
        <a href="{% url 'all_requests' %}">Вернуться к списку заявок</a><br>
        <a href="{% url 'new_request_complaints' %}">Вернуться к списку замечаний</a>
        {% else %}
        <a href="{% url 'tenant_requests' user.tenant.full_name %}">Вернуться к выбору заявки</a>
        {% endif %}
    </div>
    <div class="col-10 mx-auto col-md-4 col-lg-6">
        <h3 class="editContent text-center">Оставить отзыв</h3>
        <form action="{% url 'request_comment_create' request.id %}" method="post" class="mt-4" id="comment_form">
            {% csrf_token %}
            <input type="hidden" name="initial" id="initial_comment" value="">
            <div class="form-group editContent">
                <label for="comment" class="editContent">Ваш комментарий *</label>
                {% if user|has_group:"Manager" %}
                <div id="new_status_div" hidden>
                    <label for="new_status">Статус замечания:</label>
                    <select name="new_status" id="new_status">
                        <option id="initial_status" value="">Не изменять статус</option>
                        <option value="На рассмотрении">На рассмотрении</option>
                        <option value="Отклонено">Отклонено</option>
                        <option value="Принято к устранению">Принято к устранению</option>
                        <option value="Устранено">Устранено</option>
                    </select>
                </div>
                {% endif %}
                {% if user|has_group:"Tenant" %}
                <input type="radio" name="status" value="Отзыв" id="feedback" required checked>
                <label for="feedback" class="editContent">Отзыв</label>
                <input type="radio" name="status" value="Замечание" id="complaint" required>
                <label for="complaint" class="editContent">Замечание</label>
                {% endif %}
                <textarea class="form-control border" rows="3" name="text" id="comment" required></textarea>
                <button type="submit" class="col-12 btn btn-success d-block mx-auto">Отправить</button>
            </div>
        </form>
        <div>
        {% for comment in request.get_comments %}
            <div class="mt-3">
                <div>
                    <h5>{{ comment.user.username }}</h5>
                    <p>{{ comment.submission_date }}</p>
                    <p>{{ comment.text }}</p>
                    {% if comment.status != 'Отзыв' and not comment.user|has_group:"Manager" %}
                    <a href="#comment_form" onclick="reply('{{ comment.user.username }}', '{{ comment.id }}', '{{ comment.status }}')">Ответить</a>
                    {% endif %}
                </div>
            </div>
            {% for comm in comment.requestcomment_set.all %}
            <div class="ps-5 mt-3">
                <div>
                    <h5>{{ comm.user.username }}</h5>
                    <p>{{ comm.submission_date }}</p>
                    <p>{{ comm.text }}</p>
                </div>
            </div>
            {% endfor %}
        {% endfor %}
        </div>
    </div>
    <script>
        function reply(username, id, status) {
            document.getElementById("initial_comment").value = id
            document.getElementById("initial_status").value = status
            document.getElementById("comment").innerText = `${ username }, `
            document.getElementById("new_status_div").hidden = false
        }
    </script>

{% endblock %}